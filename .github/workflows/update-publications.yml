name: Update publications

on:
  schedule:
    # Daily at 02:17 UTC
    - cron: "17 2 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: update-publications
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      # This repo blocks third-party actions; do everything with shell commands.
      - name: Checkout
        env:
          TOKEN: ${{ secrets.PUBLICATIONS_BOT_TOKEN || github.token }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git init .
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git fetch --depth=1 origin "${REF_NAME}"
          git checkout -B "${REF_NAME}" FETCH_HEAD

      - name: Ensure Node.js (>= 18)
        run: |
          set -euo pipefail
          if ! command -v node >/dev/null 2>&1; then
            echo "Node.js is not installed on this runner image."
            exit 1
          fi
          major="$(node -p "process.versions.node.split('.')[0]")"
          if [ "${major}" -lt 18 ]; then
            echo "Node.js is too old: $(node -v). Need >= 18."
            exit 1
          fi
          node -v

      - name: Update data/publications.json
        env:
          AFFILIATION: Ukrainian Institute for Systems Biology and Medicine
          # Optional: include common variants, one per line or separated by "|"
          # AFFILIATION_ALIASES: |
          #   Ukrainian Institute for Systems Biology and Medicine, Kyiv, Ukraine
          # Ensure only records that actually contain the phrase in affiliation are kept.
          STRICT_AFFILIATION: "true"
          OUTFILE: data/publications.json
        run: node scripts/update-publications.mjs

      - name: Commit changes (if any)
        env:
          TOKEN: ${{ secrets.PUBLICATIONS_BOT_TOKEN || github.token }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/publications.json
          git commit -m "chore: update publications data"
          git push "https://x-access-token:${TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "HEAD:${REF_NAME}"
